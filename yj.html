<!DOCTYPE html>
<html>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <head>
    <title></title>
    <script src="js/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.0/dist/aframe-extras.min.js"></script>
    <script src="https://rawgit.com/mayognaise/aframe-gif-shader/master/dist/aframe-gif-shader.min.js"></script>
    <script src="https://rawgit.com/mayognaise/aframe-gif-component/master/dist/aframe-gif-component.min.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@5.0.0/dist/aframe-event-set-component.min.js"></script>
    <script src="./js/aframe-look-at-component.min.js"></script>
    <script src="./js/aframe-texture-animator.js"></script>
    <!-- <script src="https://unpkg.com/aframe-proxy-event-component/dist/aframe-proxy-event-component.min.js"></script> -->
    <!-- <script src="https://raw.githack.com/jeromeetienne/AR.js/2.0.8/aframe/build/aframe-ar.js"></script> -->
    <style>h1 {text-align: center; color: blue;}</style>
    <!-- Create Video Feed Background using https://glitch.com/edit/#!/stack-57493298?path=index.html%3A15%3A0 -->
    <style>   
      #webcam {
          opacity:1;
          position: fixed;
          background-size: 100% 100%;
          top: 0; left: 0; 
          min-width: 100%; min-height: 100%;
          width: auto; height: auto;
          z-index: -1;
      }
      .intro-overlay {
            z-index: 1;
            position: absolute;
            top: 20px;
            left: 20px;
            max-width: 700px;
            box-sizing: border-box;
            padding: 1.5em;
            color: #FFF;
            background: rgba(0, 0, 0, 0.75);
            font-family: Source Sans Pro, Helvetica Neue, Helvetica, Arial, sans-serif;
      }
    </style>
    <script>
      var cameraView;
      var ua = window.navigator.userAgent.toLowerCase(); // for Wechat detection
      var constraints = {
          audio: false,
          video: {
              facingMode: "environment",
          }
      };

      // Access the device camera and stream to cameraView
      function cameraStart() {
          
          // Detect if Wechat
          if (ua.match(/MicroMessenger/i) == 'micromessenger') {
              alert("AR体验暂不支持微信\n请用原生浏览器（如Safari）打开页面并允许使用设备相机");
          }

          cameraView = document.querySelector("#webcam");
          navigator.mediaDevices
              .getUserMedia(constraints)
              .then(function(stream) {
              cameraView.srcObject = stream;
          })
          .catch(function(error) {
              // console.error("Oops. Something is broken.", error);
              alert("当前浏览器不支持AR\n请用原生浏览器（如Safari）打开页面并允许使用设备相机");
          });
          
      }

      // Start the video stream when the window loads
      window.addEventListener("load", cameraStart, false);

      // 
      function togglePlayback(id) {
          document.getElementById(id).components.gif.togglePlayback()
        }

    </script>

  </head>
  <body>
    <!-- <h1>测试页面</h1> -->
    <!-- <div id="dialog" class="intro-overlay">
      <h1>测试页面</h1>
      <button onclick="activateScene()" type="button">开始</button>
      <a href="javascript:togglePlayback('opponent')">toggle playback</a>
    </div> -->
    <video id="webcam" autoplay playsinline></video>

    <a-scene renderer="antialias: true; colorManagement: true;" 
             loading-screen="dotsColor: #e2e2dc; backgroundColor: #e2e2e2" vr-mode-ui="enabled: false"> 
      <a-assets>
        <a-asset-item id="model" src="assets/yu_ji/scene.gltf"></a-asset-item>
        <a-asset-item id="huaquan-model" src="assets/huaquan/huaquan.gltf"></a-asset-item>
        <audio id="voice" src="assets/yu_ji/yj1.mp3" preload="true"></audio>
        <img id="1" src="assets/img/st.png" preload="true">
        <img id="2" src="assets/img/jd.png" preload="true">
        <img id="3" src="assets/img/bu.png" preload="true">
        <img id="huaquan" src="assets/img/huaquan.gif">
      </a-assets>

      <a-entity id="mouseCursor" cursor="rayOrigin: mouse"></a-entity>
      <a-entity camera position="0 1 0" rotation="-5 0 0">
        <!-- game -->
        <a-entity position="0 -0.25 -0.4" scale="0.1 0.1 0.1" animation="property: position; from: 0 -0.25 0; to: 0 -0.25 -0.4; delay: 240; dur: 800; loop: false">
          <!-- <a-image src="#st" position="-1.2 0 0" event-set__click="scale: 4 4 4"  event-set__1="_event: mouseleave; scale: 1 1 1"></a-image> -->
          <a-image src="#1" position="-1.2 0 0" animation__click1="property: position; startEvents: click; to: 0 1.5 0.5; dur: 200"></a-image>
          <a-image src="#2" position="0 0 0" event-set__click2="_event: click; _target: #opponent; material.transparent: false"></a-image>
          <a-image src="#3" position="1.2 0 0" event-set__click3="_event: click; _target: #npc; animation-mixer.timeScale: 1; "></a-image>
        </a-entity>
        
        <a-entity position="0 0 -0.4" scale="0.1 0.1 0.1">
          <a-entity id="opponent" geometry="primitive:plane;" material="shader:gif; src: #huaquan; transparent: true"></a-entity>
          <!-- <a-entity id="opponent" geometry="primitive:plane;" material=></a-entity> -->
          <!-- <a-entity id="opponent" gltf-model="#huaquan-model" scale="0.5 0.5 0.5" rotation="90 0 0" animation-mixer="timeScale: 10"></a-entity> -->
          <!-- <a-entity>
            <a-image src="#1" side="front" visible="" animation="property: visible; from: true; to: false; delay: 1000; dur: 5000; loop: true; dir: "></a-image>
            <a-image src="#2" side="front" visible="" animation="property: visible; from: true; to: false; delay: 3000; dur: 3000; loop: true; dir: "></a-image>
            <a-image src="#3" side="front" visible="" animation="property: visible; from: true; to: false; delay: 5000; dur: 1000; loop: true; dir: "></a-image>
          </a-entity> -->
        </a-entity>
      </a-entity>
      
<!-- TEST -->
      <a-cylinder position="1 0.75 -3" radius="0.5" height="1.5" color="#FFC65D"
      event-set__enter="_event: mouseenter; _target: #cylinderText; visible: true"
      event-set__leave="_event: mouseleave; _target: #cylinderText; visible: false">
<a-text id="cylinderText" value="This is a cylinder" align="center" color="#FFF" visible="false" position="0 -0.55 0.55"
    geometry="primitive: plane; width: 1.75" material="color: #333"></a-text>
</a-cylinder>
<a-box position="-1 0.5 -3" rotation="0 45 0" color="#4CC3D9"
event-set__enter="_event: mouseenter; color: #8FF7FF"
event-set__leave="_event: mouseleave; color: #4CC3D9"></a-box>

<a-sphere position="0 1.25 -5" radius="1.25" color="#EF2D5E"
   event-set__down="_event: mousedown; scale: 1.2 1.2 1.2"
   event-set__up="_event: mouseup; scale: 1 1 1"
   event-set__leave="_event: mouseleave; scale: 1 1 1"></a-sphere>

   <!-- TEST END -->

      <a-entity light="color: #eee; intensity: 1" position="0 1 2"></a-entity>
      <a-entity light="type: ambient; color: #eee; intensity: 1"></a-entity>

      <a-entity id="npc" gltf-model="#model" scale="0.2 0.2 0.2" position="0 0 -2" rotation="0 0 0" animation-mixer="clip: yuji-jinchang; timeScale: 0; loop: once" sound="src: #voice; autoplay: true"></a-entity>
      <!-- <a-entity gltf-model="#model" scale="0.2 0.2 0.2" position="0 0 -2" rotation="0 0 0" animation-mixer="clip: yuji-xunhuan; loop: repeat"></a-entity> -->

    </a-scene>
  </body>
</html>